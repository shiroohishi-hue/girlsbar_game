<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>BAR NOIR - ã‚¬ãƒ¼ãƒ«ã‚ºãƒãƒ¼çµŒå–¶ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</title>
<style>
  :root {
    --bg: #0a0a0f;
    --bg2: #111118;
    --bg3: #1a1a24;
    --card: #16161f;
    --card2: #1e1e2a;
    --border: #2a2a3a;
    --accent: #c8a96e;
    --accent2: #e8c98e;
    --accent3: #8e7a5a;
    --red: #c05050;
    --green: #50a070;
    --blue: #5080c0;
    --purple: #8060c0;
    --text: #d0d0d8;
    --text2: #8888a0;
    --text3: #555568;
    --danger: #e05050;
    --warn: #d0a030;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  html, body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
    font-size: 14px;
    line-height: 1.4;
    min-height: 100vh;
    overflow-x: hidden;
  }
  #app { max-width: 480px; margin: 0 auto; padding-bottom: 160px; position: relative; }

  /* HEADER */
  #header {
    position: sticky; top: 0; z-index: 100;
    background: rgba(10,10,15,0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border);
    padding: 10px 12px 8px;
  }
  #header-top {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 8px;
  }
  #store-name {
    font-size: 18px; font-weight: 700;
    letter-spacing: 3px;
    color: var(--accent);
    text-transform: uppercase;
  }
  #day-info { font-size: 12px; color: var(--text2); text-align: right; }
  #day-num { font-size: 20px; font-weight: 700; color: var(--text); }

  /* STATUS CARDS */
  #status-grid {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 8px; padding: 10px 12px;
  }
  .stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
  }
  .stat-label { font-size: 10px; color: var(--text2); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 4px; }
  .stat-value { font-size: 22px; font-weight: 700; color: var(--accent2); }
  .stat-value.danger { color: var(--danger); }
  .stat-value.warn { color: var(--warn); }
  .stat-sub { font-size: 10px; color: var(--text3); margin-top: 2px; }

  /* SECTION HEADERS */
  .section-title {
    font-size: 11px; letter-spacing: 2px; text-transform: uppercase;
    color: var(--accent3);
    padding: 10px 12px 6px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 8px;
  }
  .section-title::before { content: ''; display: block; width: 3px; height: 12px; background: var(--accent); border-radius: 2px; }

  /* CAST CARDS */
  #cast-section { padding: 0 12px; }
  .cast-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    margin: 8px 0;
    overflow: hidden;
    transition: border-color 0.2s;
  }
  .cast-card.low-morale { border-color: var(--red); }
  .cast-card-inner { display: flex; gap: 0; }
  .cast-img-wrap {
    width: 90px; flex-shrink: 0;
    aspect-ratio: 3/4;
    overflow: hidden;
    background: var(--bg3);
    position: relative;
  }
  .cast-img {
    width: 100%; height: 100%;
    object-fit: cover;
    object-position: center top;
    display: block;
  }
  .cast-img-placeholder {
    width: 100%; height: 100%;
    display: flex; align-items: center; justify-content: center;
    font-size: 32px;
    background: linear-gradient(135deg, var(--bg3), var(--card2));
  }
  .cast-info { flex: 1; padding: 10px 10px 10px 10px; min-width: 0; }
  .cast-name { font-size: 15px; font-weight: 700; color: var(--text); margin-bottom: 2px; }
  .cast-title { font-size: 10px; color: var(--accent3); margin-bottom: 8px; }
  .param-row { margin-bottom: 5px; }
  .param-label { font-size: 10px; color: var(--text2); display: flex; justify-content: space-between; margin-bottom: 2px; }
  .param-bar { height: 4px; background: var(--bg3); border-radius: 2px; overflow: hidden; }
  .param-fill {
    height: 100%; border-radius: 2px;
    transition: width 0.3s;
  }
  .fill-gold { background: linear-gradient(90deg, var(--accent3), var(--accent2)); }
  .fill-blue { background: linear-gradient(90deg, #406090, var(--blue)); }
  .fill-green { background: linear-gradient(90deg, #308050, var(--green)); }
  .fill-red { background: linear-gradient(90deg, #803030, var(--red)); }
  .fill-purple { background: linear-gradient(90deg, #504080, var(--purple)); }
  .fill-orange { background: linear-gradient(90deg, #806030, #c09040); }

  .cast-footer {
    padding: 8px 10px;
    border-top: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
    font-size: 11px; color: var(--text2);
  }
  .cast-badge {
    font-size: 10px; padding: 2px 8px;
    border-radius: 20px; font-weight: 600;
  }
  .badge-risk { background: rgba(192,80,80,0.2); color: var(--red); border: 1px solid rgba(192,80,80,0.3); }
  .badge-ok { background: rgba(80,160,112,0.2); color: var(--green); border: 1px solid rgba(80,160,112,0.3); }
  .badge-warn { background: rgba(208,160,48,0.2); color: var(--warn); border: 1px solid rgba(208,160,48,0.3); }

  /* CHART */
  #chart-section { padding: 0 12px 10px; }
  #sales-chart {
    width: 100%; height: 120px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--card);
    display: block;
  }

  /* EVENT LOG */
  #log-section { padding: 0 12px; }
  #event-log { }
  .log-item {
    padding: 8px 10px;
    background: var(--card);
    border-left: 3px solid var(--border);
    border-radius: 0 6px 6px 0;
    margin: 6px 0;
    font-size: 12px;
    color: var(--text2);
  }
  .log-item.log-good { border-color: var(--green); color: var(--text); }
  .log-item.log-bad { border-color: var(--red); color: var(--text); }
  .log-item.log-warn { border-color: var(--warn); }
  .log-day { font-size: 10px; color: var(--text3); margin-bottom: 2px; }

  /* ACTION BUTTONS */
  #action-area {
    position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
    width: 100%; max-width: 480px;
    background: rgba(10,10,15,0.97);
    backdrop-filter: blur(12px);
    border-top: 1px solid var(--border);
    padding: 10px 12px 16px;
    z-index: 200;
  }
  #action-tabs {
    display: flex; gap: 4px; margin-bottom: 10px;
  }
  .tab-btn {
    flex: 1; padding: 6px 4px; font-size: 10px;
    background: var(--bg3); border: 1px solid var(--border);
    color: var(--text2); border-radius: 6px; cursor: pointer;
    letter-spacing: 0.5px; transition: all 0.15s;
    min-height: 36px;
  }
  .tab-btn.active {
    background: var(--accent3); border-color: var(--accent);
    color: var(--accent2); font-weight: 700;
  }
  .tab-btn:active { opacity: 0.7; transform: scale(0.97); }
  #action-panel { }
  .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .action-btn {
    padding: 12px 8px; font-size: 13px; font-weight: 600;
    background: var(--card2); border: 1px solid var(--border);
    color: var(--text); border-radius: 8px; cursor: pointer;
    min-height: 44px; text-align: center; transition: all 0.15s;
    line-height: 1.3;
  }
  .action-btn.primary {
    background: linear-gradient(135deg, #7a5a30, var(--accent3));
    border-color: var(--accent); color: var(--accent2);
    font-size: 15px;
  }
  .action-btn.full { grid-column: 1 / -1; }
  .action-btn:active { opacity: 0.7; transform: scale(0.97); }
  .action-btn:disabled { opacity: 0.4; pointer-events: none; }
  .action-btn .btn-cost { font-size: 10px; color: var(--text2); font-weight: 400; display: block; margin-top: 2px; }

  /* MODAL */
  #modal-overlay {
    display: none; position: fixed; inset: 0; z-index: 500;
    background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
    align-items: flex-end; justify-content: center;
  }
  #modal-overlay.show { display: flex; }
  #modal {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 16px 16px 0 0;
    width: 100%; max-width: 480px;
    padding: 20px 16px 30px;
    max-height: 80vh; overflow-y: auto;
  }
  #modal-title { font-size: 16px; font-weight: 700; color: var(--accent2); margin-bottom: 8px; }
  #modal-body { font-size: 13px; color: var(--text); line-height: 1.6; margin-bottom: 16px; }
  #modal-choices { display: flex; flex-direction: column; gap: 8px; }
  .choice-btn {
    padding: 14px 16px; font-size: 13px;
    background: var(--card2); border: 1px solid var(--border);
    color: var(--text); border-radius: 8px; cursor: pointer;
    text-align: left; min-height: 48px; transition: all 0.15s;
  }
  .choice-btn:active { opacity: 0.7; transform: scale(0.98); }
  .choice-effect { font-size: 11px; color: var(--text2); margin-top: 4px; }

  /* SLIDER */
  .slider-wrap { padding: 8px 0; }
  .slider-wrap label { font-size: 12px; color: var(--text2); display: flex; justify-content: space-between; margin-bottom: 6px; }
  input[type=range] {
    width: 100%; height: 6px;
    accent-color: var(--accent);
    cursor: pointer;
  }

  /* ENDING */
  #ending-screen {
    display: none; position: fixed; inset: 0; z-index: 600;
    background: var(--bg); overflow-y: auto;
    padding: 40px 16px 40px;
    max-width: 480px; margin: 0 auto;
  }
  #ending-screen.show { display: block; }
  .ending-title { font-size: 28px; font-weight: 700; color: var(--accent); letter-spacing: 4px; text-align: center; margin-bottom: 8px; }
  .ending-sub { font-size: 12px; color: var(--text2); text-align: center; letter-spacing: 2px; margin-bottom: 30px; }
  .ending-grade { font-size: 72px; font-weight: 700; text-align: center; margin: 20px 0; color: var(--accent2); }
  .ending-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); font-size: 14px; }
  .ending-row span:last-child { font-weight: 700; color: var(--accent2); }
  .ending-comment { margin: 20px 0; padding: 16px; background: var(--card); border-radius: 8px; font-size: 13px; color: var(--text2); line-height: 1.6; }

  /* GAMEOVER */
  #gameover-screen {
    display: none; position: fixed; inset: 0; z-index: 600;
    background: rgba(10,0,0,0.97);
    align-items: center; justify-content: center; flex-direction: column;
    text-align: center; padding: 40px 20px;
  }
  #gameover-screen.show { display: flex; }
  .go-title { font-size: 40px; font-weight: 700; color: var(--danger); letter-spacing: 4px; margin-bottom: 16px; }
  .go-sub { font-size: 14px; color: var(--text2); margin-bottom: 30px; }

  /* MISC */
  .mt8 { margin-top: 8px; }
  .gold { color: var(--accent2); }
  .red { color: var(--red); }
  .green { color: var(--green); }
  .divider { height: 1px; background: var(--border); margin: 8px 12px; }

  /* SAVE BUTTONS */
  #save-btns { display: flex; gap: 6px; padding: 8px 12px; }
  .save-btn {
    flex: 1; padding: 8px; font-size: 11px;
    background: var(--bg3); border: 1px solid var(--border);
    color: var(--text2); border-radius: 6px; cursor: pointer;
    min-height: 36px; transition: all 0.15s;
  }
  .save-btn:active { opacity: 0.7; }

  /* SCROLLBAR */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* TOAST */
  #toast {
    position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
    background: var(--card2); border: 1px solid var(--accent);
    color: var(--accent2); padding: 10px 20px; border-radius: 8px;
    font-size: 13px; font-weight: 600;
    z-index: 700; opacity: 0; transition: opacity 0.3s;
    pointer-events: none; white-space: nowrap;
  }
  #toast.show { opacity: 1; }
</style>
</head>
<body>
<div id="app">
  <div id="header">
    <div id="header-top">
      <div id="store-name">BAR NOIR</div>
      <div id="day-info">
        <div id="day-num">DAY 1</div>
        <div style="font-size:10px;color:var(--text3)">/ 180æ—¥</div>
      </div>
    </div>
  </div>

  <!-- STATUS GRID -->
  <div id="status-grid">
    <div class="stat-card">
      <div class="stat-label">ğŸ’´ æ‰€æŒè³‡é‡‘</div>
      <div class="stat-value" id="s-money">Â¥1,000,000</div>
      <div class="stat-sub" id="s-money-sub">å…ˆé€±æ¯” â€”</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">â­ åº—ã®è©•åˆ¤</div>
      <div class="stat-value" id="s-rep">50</div>
      <div class="stat-sub" id="s-rep-sub">/ 100</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ğŸ¥ƒ åº—é•·ã‚¹ãƒˆãƒ¬ã‚¹</div>
      <div class="stat-value" id="s-stress">20</div>
      <div class="stat-sub">/ 100ã€€â€»100ã§GO</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ğŸº åˆ¤æ–­åŠ›</div>
      <div class="stat-value" id="s-judge">80</div>
      <div class="stat-sub" id="s-drink-sub">é£²é…’é‡: 0</div>
    </div>
  </div>

  <!-- CAST SECTION -->
  <div class="section-title">ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§</div>
  <div id="cast-section"></div>

  <!-- CHART -->
  <div class="section-title" style="margin-top:8px;">å£²ä¸Šæ¨ç§»</div>
  <div id="chart-section">
    <canvas id="sales-chart"></canvas>
  </div>

  <!-- EVENT LOG -->
  <div class="section-title">ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°</div>
  <div id="log-section">
    <div id="event-log"></div>
  </div>

  <!-- SAVE BUTTONS -->
  <div id="save-btns">
    <button class="save-btn" onclick="saveGame()">ğŸ’¾ ã‚»ãƒ¼ãƒ–</button>
    <button class="save-btn" onclick="loadGame()">ğŸ“‚ ãƒ­ãƒ¼ãƒ‰</button>
    <button class="save-btn" onclick="resetGame()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
</div>

<!-- ACTION AREA -->
<div id="action-area">
  <div id="action-tabs">
    <button class="tab-btn active" onclick="switchTab('main')">å–¶æ¥­</button>
    <button class="tab-btn" onclick="switchTab('invest')">æŠ•è³‡</button>
    <button class="tab-btn" onclick="switchTab('care')">ã‚±ã‚¢</button>
    <button class="tab-btn" onclick="switchTab('mgr')">åº—é•·</button>
  </div>
  <div id="action-panel"></div>
</div>

<!-- MODAL -->
<div id="modal-overlay">
  <div id="modal">
    <div id="modal-title"></div>
    <div id="modal-body"></div>
    <div id="modal-choices"></div>
  </div>
</div>

<!-- ENDING -->
<div id="ending-screen">
  <div class="ending-title">FINAL REPORT</div>
  <div class="ending-sub">6ãƒ¶æœˆé–“ã®çµŒå–¶çµæœ</div>
  <div class="ending-grade" id="ending-grade">B</div>
  <div id="ending-details"></div>
  <div class="ending-comment" id="ending-comment"></div>
  <button class="action-btn primary full mt8" onclick="resetGame()" style="margin-top:20px;">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤ã™ã‚‹</button>
</div>

<!-- GAMEOVER -->
<div id="gameover-screen">
  <div class="go-title">GAME OVER</div>
  <div class="go-sub" id="go-reason">åº—é•·ã®ã‚¹ãƒˆãƒ¬ã‚¹ãŒé™ç•Œã«é”ã—ãŸ</div>
  <button class="action-btn primary" onclick="resetGame()" style="padding:16px 40px;">ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>
</div>

<!-- TOAST -->
<div id="toast" id="toast"></div>

<script>
// =====================================
// IMAGE CONFIGURATION (å·®ã—æ›¿ãˆå¯èƒ½)
// =====================================
const CAST_IMAGES = [
  '', // cast[0] - URLã‚’å…¥ã‚Œã‚‹ã¨ç”»åƒè¡¨ç¤º
  '', // cast[1]
  '', // cast[2]
  '', // cast[3] - å¼•ãæŠœãå¾Œè¿½åŠ ã®å ´åˆãªã©
];
const CAST_PLACEHOLDER_ICONS = ['ğŸ‘©', 'ğŸ‘©â€ğŸ¦±', 'ğŸ‘©â€ğŸ¦³', 'ğŸ‘©â€ğŸ¦°'];

// =====================================
// GAME STATE
// =====================================
let G = {};

function initState() {
  G = {
    day: 1,
    money: 1000000,
    rep: 50,
    stress: 20,
    drinking: 0,
    judgment: 80,
    adBudget: 0,
    drinkBackRate: 30,
    regularRate: 0.2,
    salesHistory: [],
    logs: [],
    gameOver: false,
    ended: false,
    totalRevenue: 0,
    totalCost: 0,
    regularCount: 0,
    totalCustomers: 0,
    casts: [
      createCast(0, 'ã‚¢ã‚«ãƒ', 'No.1ãƒ›ã‚¹ãƒ†ã‚¹', 70, 65, 80, 70, 20, 85),
      createCast(1, 'ãƒŸã‚µã‚­', 'ã‚µãƒ–ã‚­ãƒ£ã‚¹ãƒˆ', 50, 55, 75, 60, 15, 80),
      createCast(2, 'ãƒ¦ã‚¤', 'æ–°äºº', 35, 40, 85, 50, 10, 90),
    ],
    eventQueue: [],
    pendingEvent: null,
  };
}

function createCast(idx, name, title, service, attract, mental, trust, fatigue, morale) {
  return { idx, name, title, service, attract, mental, trust, fatigue, morale, active: true };
}

// =====================================
// CORE LOGIC
// =====================================
function calcRevenue() {
  const activeCasts = G.casts.filter(c => c.active);
  if (activeCasts.length === 0) return { revenue: 0, customers: 0, regulars: 0 };
  
  const avgService = avg(activeCasts.map(c => c.service));
  const avgAttract = avg(activeCasts.map(c => c.attract));
  const avgMental = avg(activeCasts.map(c => c.mental));
  
  // Base customers from rep + ad + cast attraction
  let baseCustomers = Math.floor((G.rep * 0.4 + avgAttract * 0.4 + Math.sqrt(G.adBudget / 1000) * 0.2) * 0.8 + 5);
  baseCustomers = clamp(baseCustomers, 2, 50);
  
  // Customer type distribution
  let regulars = 0, highValue = 0, trouble = 0;
  for (let i = 0; i < baseCustomers; i++) {
    const r = Math.random();
    if (r < G.regularRate) regulars++;
    else if (r < G.regularRate + 0.1) highValue++;
    else if (r < G.regularRate + 0.15) trouble++;
  }
  
  // Handle trouble customers
  if (trouble > 0) {
    const dmg = trouble * 3;
    G.rep = clamp(G.rep - dmg, 0, 100);
    G.stress = clamp(G.stress + trouble * 4, 0, 100);
    activeCasts.forEach(c => { c.mental = clamp(c.mental - trouble * 5, 0, 100); });
    addLog(`âš  ãƒˆãƒ©ãƒ–ãƒ«å®¢${trouble}åæ¥åº—ã€‚è©•åˆ¤-${dmg}ã€ã‚¹ãƒˆãƒ¬ã‚¹+${trouble*4}`, 'log-bad');
  }
  
  // Base unit price: service * mental quality factor
  const mentalFactor = avgMental / 100;
  const unitPrice = Math.floor((avgService * 0.5 + 30) * mentalFactor * (1 + G.drinkBackRate / 200));
  
  // Revenue per customer type
  const normalRev = (baseCustomers - regulars - highValue - trouble) * unitPrice * 100;
  const regularRev = regulars * unitPrice * 130;
  const highRev = highValue * unitPrice * 250;
  
  const gross = Math.floor(normalRev + regularRev + highRev);
  
  // Costs
  const rentCost = 300000; // å®¶è³ƒ30ä¸‡
  const staffCost = activeCasts.length * 80000; // ã‚­ãƒ£ã‚¹ãƒˆäººä»¶è²»
  const adCost = G.adBudget;
  const totalCost = Math.floor((rentCost + staffCost + adCost) / 25); // 1æ—¥åˆ†
  
  return { revenue: gross, customers: baseCustomers, regulars, highValue, trouble, cost: totalCost };
}

function doBusinessDay() {
  if (G.gameOver || G.ended) return;
  
  const result = calcRevenue();
  const net = result.revenue - result.cost;
  G.money += net;
  G.totalRevenue += result.revenue;
  G.totalCost += result.cost;
  G.totalCustomers += result.customers;
  G.regularCount += result.regulars;
  
  // Update regular rate slowly
  if (result.customers > 0) {
    G.regularRate = clamp(G.regularRate + (result.regulars / result.customers - G.regularRate) * 0.05, 0.05, 0.6);
  }
  
  // Rep changes
  G.rep = clamp(G.rep + (net > 0 ? 0.5 : -1), 0, 100);
  
  // Cast fatigue / mental
  G.casts.forEach(c => {
    if (!c.active) return;
    c.fatigue = clamp(c.fatigue + rand(3, 7), 0, 100);
    c.mental = clamp(c.mental - c.fatigue * 0.1 + rand(0, 2), 0, 100);
    c.trust = clamp(c.trust + (G.rep > 50 ? 1 : -0.5), 0, 100);
    c.morale = clamp(c.morale - (c.trust < 40 ? 2 : 0) - (c.mental < 30 ? 2 : 0) + rand(0, 1), 0, 100);
    // Quit risk
    if (c.morale < 20 && Math.random() < 0.08) {
      c.active = false;
      addLog(`ğŸ’” ${c.name}ãŒé€€åº—ã—ã¾ã—ãŸ`, 'log-bad');
    }
  });
  
  // Stress
  G.stress = clamp(G.stress + (net < 0 ? 3 : -0.5) + rand(-1, 2), 0, 100);
  G.judgment = clamp(100 - G.drinking * 0.5 - G.stress * 0.2, 10, 100);
  
  // Ad budget resets per day
  G.adBudget = 0;
  
  G.salesHistory.push(result.revenue);
  if (G.salesHistory.length > 30) G.salesHistory.shift();
  
  const sign = net >= 0 ? '+' : '';
  addLog(`Day${G.day}å–¶æ¥­çµ‚äº†ã€‚å£²ä¸ŠÂ¥${fmt(result.revenue)} çµŒè²»Â¥${fmt(result.cost)} ç´”ç›Š${sign}Â¥${fmt(net)}`, net >= 0 ? 'log-good' : 'log-bad');
  
  G.day++;
  
  // Random events
  if (Math.random() < 0.2 && G.judgment > 30) {
    triggerRandomEvent();
    return; // Event will advance day after choice
  }
  
  checkEnd();
  autoSave();
  render();
}

// =====================================
// EVENTS
// =====================================
const EVENTS = [
  {
    id: 'poach',
    title: 'äººæ°—ã‚­ãƒ£ã‚¹ãƒˆã¸ã®å¼•ãæŠœãã‚ªãƒ•ã‚¡ãƒ¼',
    body: () => {
      const c = activeCast();
      return c ? `${c.name}ã«ä»–åº—ã‹ã‚‰ã‚¹ã‚«ã‚¦ãƒˆãŒæ¥ãŸã€‚å¼•ãæ­¢ã‚ã‚‹ã‹ï¼Ÿ` : 'å¼•ãæŠœãã‚ªãƒ•ã‚¡ãƒ¼ãŒæ¥ãŸãŒå¯¾è±¡è€…ä¸æ˜ã€‚';
    },
    choices: [
      { label: 'çµ¦ä¸ã‚’ä¸Šã’ã¦å¼•ãæ­¢ã‚ã‚‹ï¼ˆæœˆ+3ä¸‡ï¼‰', effect: () => { G.money -= 30000; const c = activeCast(); if(c){c.morale=clamp(c.morale+30,0,100);c.trust=clamp(c.trust+20,0,100);addLog('çµ¦ä¸ã‚¢ãƒƒãƒ—ã§å¼•ãæ­¢ã‚æˆåŠŸ',  'log-good');} }, costHint: 'Â¥30,000' },
      { label: 'æ§˜å­ã‚’è¦‹ã‚‹ï¼ˆå¼•ãæŠœããƒªã‚¹ã‚¯ã‚ã‚Šï¼‰', effect: () => { const c = activeCast(); if(c && Math.random()<0.5){c.active=false; addLog(`${c.name}ãŒå¼•ãæŠœãã«å¿œã˜é€€åº—ã—ãŸ`, 'log-bad');}else{addLog('å¼•ãæŠœãã¯æœªé‚ã«çµ‚ã‚ã£ãŸ','log-warn');} } },
      { label: 'å¼•ãæ­¢ã‚ãªã„ï¼ˆåˆ¥ã‚­ãƒ£ã‚¹ãƒˆæ¡ç”¨è²»ã‚’è²¯ã‚ã‚‹ï¼‰', effect: () => { addLog('ã‚­ãƒ£ã‚¹ãƒˆé€€åº—ã‚’å—ã‘å…¥ã‚ŒãŸã€‚å¾Œä»»ã‚’æ¢ã™ã€‚','log-warn'); } },
    ]
  },
  {
    id: 'sns',
    title: 'SNSç‚ä¸Šç™ºç”Ÿ',
    body: () => 'ãŠå®¢ã®SNSæŠ•ç¨¿ãŒç‚ä¸Šä¸­ã€‚å¯¾å¿œã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚',
    choices: [
      { label: 'å³åº§ã«è¬ç½ªæ–‡ã‚’æŠ•ç¨¿ï¼ˆPRè²»Â¥50,000ï¼‰', effect: () => { G.money -= 50000; G.rep = clamp(G.rep - 5, 0, 100); addLog('è¬ç½ªæŠ•ç¨¿ã§ç‚ä¸Šã‚’æŠ‘åˆ¶ã—ãŸã€‚è©•åˆ¤-5', 'log-warn'); }, costHint: 'Â¥50,000' },
      { label: 'ç„¡è¦–ã™ã‚‹ï¼ˆç‚ä¸Šç¶™ç¶šãƒªã‚¹ã‚¯ï¼‰', effect: () => { G.rep = clamp(G.rep - 20, 0, 100); G.stress += 10; addLog('ç‚ä¸Šæ”¾ç½®ã€‚è©•åˆ¤-20ã€ã‚¹ãƒˆãƒ¬ã‚¹+10', 'log-bad'); } },
      { label: 'å¼è­·å£«å¯¾å¿œï¼ˆÂ¥100,000ï¼‰', effect: () => { G.money -= 100000; G.rep = clamp(G.rep + 5, 0, 100); addLog('æ³•çš„å¯¾å¿œã§ç‚ä¸Šè§£æ±ºã€‚è©•åˆ¤+5', 'log-good'); }, costHint: 'Â¥100,000' },
    ]
  },
  {
    id: 'absent',
    title: 'ã‚­ãƒ£ã‚¹ãƒˆæ€¥æ¬ å‹¤',
    body: () => { const c = activeCast(); return c ? `${c.name}ãŒä½“èª¿ä¸è‰¯ã§æ¬ å‹¤ã—ãŸã„é€£çµ¡ãŒæ¥ãŸã€‚` : 'æ€¥æ¬ ã®é€£çµ¡ãŒæ¥ãŸã€‚'; },
    choices: [
      { label: 'äº†æ‰¿ã™ã‚‹ï¼ˆãã®æ—¥ã®å£²ä¸Š-30%ï¼‰', effect: () => { G.money = Math.floor(G.money * 0.97); addLog('æ¬ å‹¤æ‰¿èªã€‚ä»Šæ—¥ã®å£²ä¸ŠãŒæ¸›å°‘ã—ãŸã€‚', 'log-warn'); } },
      { label: 'ç„¡ç†ã«å‡ºå‹¤ã•ã›ã‚‹ï¼ˆãƒ¡ãƒ³ã‚¿ãƒ«-20ï¼‰', effect: () => { const c = activeCast(); if(c){c.mental=clamp(c.mental-20,0,100); c.morale=clamp(c.morale-15,0,100);} addLog('å¼·åˆ¶å‡ºå‹¤ã€‚ã‚­ãƒ£ã‚¹ãƒˆã®ãƒ¡ãƒ³ã‚¿ãƒ«ãŒæ‚ªåŒ–ã—ãŸã€‚', 'log-bad'); } },
      { label: 'åº—é•·ãŒä»£ã‚ã‚Šã«ãƒ•ã‚©ãƒ­ãƒ¼ï¼ˆã‚¹ãƒˆãƒ¬ã‚¹+15ï¼‰', effect: () => { G.stress=clamp(G.stress+15,0,100); addLog('åº—é•·ãŒãƒ•ã‚©ãƒ­ãƒ¼ã€‚ã‚¹ãƒˆãƒ¬ã‚¹+15', 'log-warn'); } },
    ]
  },
  {
    id: 'romance',
    title: 'æ‹æ„›ãƒˆãƒ©ãƒ–ãƒ«ç™ºç”Ÿ',
    body: () => { const c = activeCast(); return c ? `${c.name}ã¨ãŠå®¢ãŒäº¤éš›ãƒˆãƒ©ãƒ–ãƒ«ã«ãªã£ãŸã€‚` : 'æ‹æ„›ãƒˆãƒ©ãƒ–ãƒ«ãŒç™ºç”Ÿã—ãŸã€‚'; },
    choices: [
      { label: 'é–“ã«å…¥ã£ã¦ä»²è£ã™ã‚‹ï¼ˆåˆ¤æ–­åŠ›ãƒã‚§ãƒƒã‚¯ï¼‰', effect: () => { if(G.judgment > 60){ G.rep=clamp(G.rep+5,0,100); addLog('ä»²è£æˆåŠŸã€‚è©•åˆ¤+5', 'log-good');}else{ G.rep=clamp(G.rep-10,0,100); addLog('ä»²è£å¤±æ•—ã€‚è©•åˆ¤-10', 'log-bad');}  } },
      { label: 'ã‚­ãƒ£ã‚¹ãƒˆã‚’æ”¯æŒã™ã‚‹', effect: () => { const c=activeCast(); if(c){c.trust=clamp(c.trust+15,0,100); c.morale=clamp(c.morale+10,0,100);} addLog('ã‚­ãƒ£ã‚¹ãƒˆæ”¯æŒã€‚ä¿¡é ¼åº¦UP', 'log-good'); } },
      { label: 'ãŠå®¢ã‚’å„ªå…ˆã™ã‚‹ï¼ˆã‚­ãƒ£ã‚¹ãƒˆä¸æº€ï¼‰', effect: () => { const c=activeCast(); if(c){c.trust=clamp(c.trust-20,0,100); c.morale=clamp(c.morale-15,0,100);} G.rep=clamp(G.rep+3,0,100); addLog('å®¢å„ªå…ˆã€‚ã‚­ãƒ£ã‚¹ãƒˆä¿¡é ¼åº¦ä½ä¸‹', 'log-warn'); } },
    ]
  },
  {
    id: 'tax',
    title: 'ç¨å‹™èª¿æŸ»ã®é€šçŸ¥',
    body: () => 'ç¨å‹™ç½²ã‹ã‚‰èª¿æŸ»ãŒå…¥ã‚‹é€šçŸ¥ãŒå±Šã„ãŸã€‚å¸³ç°¿æ•´ç†ãŒå¿…è¦ã ã€‚',
    choices: [
      { label: 'ç¨ç†å£«ã«ä¾é ¼ï¼ˆÂ¥80,000ï¼‰', effect: () => { G.money -= 80000; addLog('ç¨ç†å£«å¯¾å¿œå®Œäº†ã€‚å•é¡Œãªã—ã€‚', 'log-good'); }, costHint: 'Â¥80,000' },
      { label: 'è‡ªåˆ†ã§å¯¾å¿œï¼ˆåˆ¤æ–­åŠ›ãŒä½ã„ã¨ãƒšãƒŠãƒ«ãƒ†ã‚£ï¼‰', effect: () => { if(G.judgment>70){ addLog('è‡ªå·±å¯¾å¿œæˆåŠŸã€‚', 'log-good');}else{ G.money=Math.floor(G.money*0.9); addLog('ç¨å‹™èª¿æŸ»ã§è¿½å¾´èª²ç¨ã€‚è³‡ç”£-10%', 'log-bad');} } },
    ]
  },
];

function triggerRandomEvent() {
  const ev = EVENTS[Math.floor(Math.random() * EVENTS.length)];
  showModal(ev.title, ev.body(), ev.choices.map(ch => ({
    label: ch.label,
    effect: () => { ch.effect(); checkEnd(); autoSave(); render(); }
  })));
}

function activeCast() {
  const ac = G.casts.filter(c => c.active);
  return ac.length > 0 ? ac[Math.floor(Math.random() * ac.length)] : null;
}

// =====================================
// ACTIONS
// =====================================
function doAdvertise(amount) {
  if (G.money < amount) { showToast('è³‡é‡‘ä¸è¶³ã§ã™'); return; }
  G.money -= amount;
  G.adBudget += amount;
  addLog(`åºƒå‘Šè²»Â¥${fmt(amount)}ã‚’æŠ•è³‡ã—ãŸ`, 'log-good');
  render();
}

function doCastCare(castIdx) {
  const cost = 10000;
  if (G.money < cost) { showToast('è³‡é‡‘ä¸è¶³ã§ã™'); return; }
  const c = G.casts[castIdx];
  if (!c || !c.active) return;
  G.money -= cost;
  c.fatigue = clamp(c.fatigue - 30, 0, 100);
  c.mental = clamp(c.mental + 20, 0, 100);
  c.morale = clamp(c.morale + 10, 0, 100);
  addLog(`${c.name}ã‚’ã‚±ã‚¢ã—ãŸï¼ˆÂ¥${fmt(cost)}ï¼‰`, 'log-good');
  render();
}

function doAllCare() {
  const ac = G.casts.filter(c => c.active);
  const cost = 10000 * ac.length;
  if (G.money < cost) { showToast('è³‡é‡‘ä¸è¶³ã§ã™'); return; }
  G.money -= cost;
  ac.forEach(c => {
    c.fatigue = clamp(c.fatigue - 25, 0, 100);
    c.mental = clamp(c.mental + 15, 0, 100);
    c.morale = clamp(c.morale + 8, 0, 100);
  });
  addLog(`å…¨ã‚­ãƒ£ã‚¹ãƒˆã‚’ã‚±ã‚¢ï¼ˆÂ¥${fmt(cost)}ï¼‰`, 'log-good');
  render();
}

function doManagerDrink() {
  G.drinking = clamp(G.drinking + 15, 0, 100);
  G.stress = clamp(G.stress - 10, 0, 100);
  G.judgment = clamp(G.judgment - 10, 10, 100);
  addLog('åº—é•·ãŒé£²é…’ã€‚ã‚¹ãƒˆãƒ¬ã‚¹-10ã€åˆ¤æ–­åŠ›-10', 'log-warn');
  render();
}

function doManagerRest() {
  G.stress = clamp(G.stress - 15, 0, 100);
  G.drinking = clamp(G.drinking - 10, 0, 100);
  addLog('åº—é•·ãŒä¼‘æ¯ã€‚ã‚¹ãƒˆãƒ¬ã‚¹-15', 'log-good');
  render();
}

function doHirecast() {
  const cost = 50000;
  if (G.money < cost) { showToast('æ¡ç”¨è²»ãŒä¸è¶³ã—ã¦ã„ã¾ã™'); return; }
  G.money -= cost;
  const newIdx = G.casts.length;
  const names = ['ãƒªãƒŠ', 'ã‚µãƒ¤', 'ãƒŠãƒŠ', 'ã‚¢ã‚ªã‚¤', 'ãƒ¢ãƒ¢'];
  const name = names[newIdx % names.length];
  G.casts.push(createCast(newIdx, name, 'æ–°äººã‚­ãƒ£ã‚¹ãƒˆ', rand(30, 50), rand(30, 50), 80, 50, 10, 85));
  addLog(`æ–°ã‚­ãƒ£ã‚¹ãƒˆ${name}ã‚’æ¡ç”¨ã—ãŸï¼ˆÂ¥${fmt(cost)}ï¼‰`, 'log-good');
  render();
}

function changeDbRate(val) {
  G.drinkBackRate = parseInt(val);
  render();
}

// =====================================
// CHECK END
// =====================================
function checkEnd() {
  if (G.stress >= 100) {
    G.gameOver = true;
    document.getElementById('go-reason').textContent = 'åº—é•·ã®ã‚¹ãƒˆãƒ¬ã‚¹ãŒé™ç•Œã«é”ã—ãŸ';
    document.getElementById('gameover-screen').classList.add('show');
    return;
  }
  if (G.money < -500000) {
    G.gameOver = true;
    document.getElementById('go-reason').textContent = 'è³‡é‡‘ãŒå°½ããŸï¼ˆè² å‚µ50ä¸‡è¶…éï¼‰';
    document.getElementById('gameover-screen').classList.add('show');
    return;
  }
  if (G.day > 180) {
    G.ended = true;
    showEnding();
  }
}

function showEnding() {
  const activeCasts = G.casts.filter(c => c.active);
  const retention = Math.round(activeCasts.length / G.casts.length * 100);
  const regularPct = G.totalCustomers > 0 ? Math.round(G.regularCount / G.totalCustomers * 100) : 0;
  const net = G.totalRevenue - G.totalCost;

  let score = 0;
  if (net > 2000000) score += 40;
  else if (net > 500000) score += 25;
  else if (net > 0) score += 10;
  score += Math.floor(G.rep * 0.25);
  score += retention * 0.15;
  score += regularPct * 0.1;
  score -= G.stress * 0.1;

  let grade, comment;
  if (score >= 80) { grade = 'S'; comment = 'ä¼èª¬çš„ãªçµŒå–¶è€…ã€‚BAR NOIRã¯åœ°åŸŸéšä¸€ã®ååº—ã¨ãªã£ãŸã€‚'; }
  else if (score >= 65) { grade = 'A'; comment = 'å„ªç§€ãªçµŒå–¶ã€‚ã‚­ãƒ£ã‚¹ãƒˆã‚‚å®¢ã‚‚ä¿¡é ¼ã‚’å¯„ã›ã‚‹ãƒãƒ¼ã«è‚²ã£ãŸã€‚'; }
  else if (score >= 50) { grade = 'B'; comment = 'åŠç¬¬ç‚¹ã®çµŒå–¶ã€‚èª²é¡Œã¯ã‚ã‚‹ãŒåŸºç›¤ã¯ã§ãã¦ã„ã‚‹ã€‚'; }
  else if (score >= 35) { grade = 'C'; comment = 'è‹¦ã—ã„6ãƒ¶æœˆã ã£ãŸã€‚æ¬¡ã¯ã‚‚ã£ã¨ã†ã¾ãã‚„ã‚Œã‚‹ã¯ãšã ã€‚'; }
  else { grade = 'D'; comment = 'çµŒå–¶ã¯å³ã—ã‹ã£ãŸã€‚ã ãŒçµŒé¨“ã¯æ¬¡ã«æ´»ãã‚‹ã€‚'; }

  document.getElementById('ending-grade').textContent = grade;
  document.getElementById('ending-details').innerHTML = `
    <div class="ending-row"><span>ç´”åˆ©ç›Š</span><span class="${net>=0?'green':'red'}">Â¥${fmt(net)}</span></div>
    <div class="ending-row"><span>æœ€çµ‚è³‡é‡‘</span><span>Â¥${fmt(G.money)}</span></div>
    <div class="ending-row"><span>åº—ã®è©•åˆ¤</span><span>${Math.round(G.rep)} / 100</span></div>
    <div class="ending-row"><span>ã‚­ãƒ£ã‚¹ãƒˆå®šç€ç‡</span><span>${retention}%</span></div>
    <div class="ending-row"><span>å¸¸é€£æ¯”ç‡</span><span>${regularPct}%</span></div>
    <div class="ending-row"><span>æœ€çµ‚ã‚¹ãƒˆãƒ¬ã‚¹</span><span class="${G.stress>70?'red':'green'}">${Math.round(G.stress)}</span></div>
    <div class="ending-row"><span>ç·åˆã‚¹ã‚³ã‚¢</span><span>${Math.round(score)}ç‚¹</span></div>
  `;
  document.getElementById('ending-comment').textContent = comment;
  document.getElementById('ending-screen').classList.add('show');
}

// =====================================
// UI / RENDER
// =====================================
function render() {
  // Header
  document.getElementById('day-num').textContent = `DAY ${G.day}`;

  // Stats
  const s = document.getElementById('s-stress');
  s.textContent = Math.round(G.stress);
  s.className = 'stat-value' + (G.stress > 80 ? ' danger' : G.stress > 60 ? ' warn' : '');
  
  document.getElementById('s-money').textContent = 'Â¥' + fmt(G.money);
  document.getElementById('s-money').className = 'stat-value' + (G.money < 0 ? ' danger' : '');
  document.getElementById('s-rep').textContent = Math.round(G.rep);
  document.getElementById('s-judge').textContent = Math.round(G.judgment);
  document.getElementById('s-drink-sub').textContent = `é£²é…’é‡: ${Math.round(G.drinking)}`;

  // Cast cards
  const castSection = document.getElementById('cast-section');
  castSection.innerHTML = '';
  G.casts.forEach((c, i) => {
    const lowMorale = c.morale < 20 && c.active;
    const badge = !c.active ? `<span class="cast-badge badge-risk">é€€åº—</span>` :
      c.morale < 20 ? `<span class="cast-badge badge-risk">é€€åº—ãƒªã‚¹ã‚¯</span>` :
      c.morale < 50 ? `<span class="cast-badge badge-warn">ä¸å®‰å®š</span>` :
      `<span class="cast-badge badge-ok">åœ¨ç±ä¸­</span>`;

    const imgUrl = CAST_IMAGES[i] || '';
    const imgHtml = imgUrl
      ? `<img class="cast-img" src="${imgUrl}" alt="${c.name}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><div class="cast-img-placeholder" style="display:none">${CAST_PLACEHOLDER_ICONS[i % CAST_PLACEHOLDER_ICONS.length]}</div>`
      : `<div class="cast-img-placeholder">${CAST_PLACEHOLDER_ICONS[i % CAST_PLACEHOLDER_ICONS.length]}</div>`;

    castSection.innerHTML += `
    <div class="cast-card ${lowMorale ? 'low-morale' : ''}" style="${!c.active ? 'opacity:0.4' : ''}">
      <div class="cast-card-inner">
        <div class="cast-img-wrap">${imgHtml}</div>
        <div class="cast-info">
          <div class="cast-name">${c.name}</div>
          <div class="cast-title">${c.title}</div>
          ${paramBar('æ¥å®¢åŠ›', c.service, 'fill-gold')}
          ${paramBar('é›†å®¢åŠ›', c.attract, 'fill-blue')}
          ${paramBar('ãƒ¡ãƒ³ã‚¿ãƒ«', c.mental, 'fill-green')}
          ${paramBar('åœ¨ç±æ„æ¬²', c.morale, c.morale < 30 ? 'fill-red' : 'fill-purple')}
          ${paramBar('ç–²åŠ´', c.fatigue, 'fill-red')}
        </div>
      </div>
      <div class="cast-footer">
        <span>ä¿¡é ¼åº¦ ${Math.round(c.trust)} / ç–²åŠ´ ${Math.round(c.fatigue)}</span>
        ${badge}
      </div>
    </div>`;
  });

  // Chart
  drawChart();

  // Logs
  const logEl = document.getElementById('event-log');
  logEl.innerHTML = '';
  const recent = G.logs.slice(-5).reverse();
  recent.forEach(l => {
    logEl.innerHTML += `<div class="log-item ${l.type}"><div class="log-day">Day ${l.day}</div>${l.msg}</div>`;
  });

  // Action panel
  renderActionPanel();
}

function paramBar(label, val, cls) {
  return `<div class="param-row">
    <div class="param-label"><span>${label}</span><span>${Math.round(val)}</span></div>
    <div class="param-bar"><div class="param-fill ${cls}" style="width:${val}%"></div></div>
  </div>`;
}

let currentTab = 'main';
function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab-btn').forEach((b, i) => {
    b.classList.toggle('active', ['main','invest','care','mgr'][i] === tab);
  });
  renderActionPanel();
}

function renderActionPanel() {
  const p = document.getElementById('action-panel');
  const ac = G.casts.filter(c => c.active);
  
  if (currentTab === 'main') {
    p.innerHTML = `
      <div class="action-grid">
        <button class="action-btn primary full" onclick="doBusinessDay()">
          ğŸª å–¶æ¥­ã™ã‚‹
          <span class="btn-cost">ã‚¿ãƒ¼ãƒ³ã‚’é€²ã‚ã‚‹</span>
        </button>
      </div>`;
  } else if (currentTab === 'invest') {
    p.innerHTML = `
      <div class="action-grid">
        <button class="action-btn" onclick="doAdvertise(30000)">ğŸ“± SNSåºƒå‘Š<span class="btn-cost">Â¥30,000</span></button>
        <button class="action-btn" onclick="doAdvertise(100000)">ğŸ“º å¤§å‹åºƒå‘Š<span class="btn-cost">Â¥100,000</span></button>
        <button class="action-btn" onclick="doHirecast()">ğŸ‘© æ–°è¦æ¡ç”¨<span class="btn-cost">Â¥50,000</span></button>
        <div style="grid-column:1/-1">
          <div class="slider-wrap">
            <label><span>ğŸ¹ ãƒ‰ãƒªãƒ³ã‚¯ãƒãƒƒã‚¯ç‡</span><span id="dbr-val">${G.drinkBackRate}%</span></label>
            <input type="range" min="10" max="60" value="${G.drinkBackRate}" oninput="changeDbRate(this.value);document.getElementById('dbr-val').textContent=this.value+'%'">
          </div>
        </div>
      </div>`;
  } else if (currentTab === 'care') {
    let btns = ac.map(c => `<button class="action-btn" onclick="doCastCare(${c.idx})">${c.name}ã‚±ã‚¢<span class="btn-cost">Â¥10,000</span></button>`).join('');
    p.innerHTML = `<div class="action-grid">
      ${btns}
      <button class="action-btn full" onclick="doAllCare()">å…¨å“¡ã‚±ã‚¢<span class="btn-cost">Â¥${fmt(10000*ac.length)}</span></button>
    </div>`;
  } else if (currentTab === 'mgr') {
    p.innerHTML = `
      <div class="action-grid">
        <button class="action-btn" onclick="doManagerDrink()">ğŸ¥ƒ é£²é…’ã™ã‚‹<span class="btn-cost">ã‚¹ãƒˆãƒ¬ã‚¹â†“ åˆ¤æ–­åŠ›â†“</span></button>
        <button class="action-btn" onclick="doManagerRest()">ğŸ˜´ ä¼‘æ¯ã™ã‚‹<span class="btn-cost">ã‚¹ãƒˆãƒ¬ã‚¹â†“â†“</span></button>
      </div>`;
  }
}

function drawChart() {
  const canvas = document.getElementById('sales-chart');
  const dpr = window.devicePixelRatio || 1;
  const w = canvas.offsetWidth;
  const h = canvas.offsetHeight;
  canvas.width = w * dpr;
  canvas.height = h * dpr;
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);

  ctx.clearRect(0, 0, w, h);
  const data = G.salesHistory;
  if (data.length < 2) {
    ctx.fillStyle = '#555568';
    ctx.font = '12px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('ãƒ‡ãƒ¼ã‚¿ãªã—', w/2, h/2);
    return;
  }

  const pad = { top: 10, right: 12, bottom: 20, left: 50 };
  const gw = w - pad.left - pad.right;
  const gh = h - pad.top - pad.bottom;

  const maxV = Math.max(...data);
  const minV = Math.min(...data);
  const range = maxV - minV || 1;

  const px = (i) => pad.left + (i / (data.length - 1)) * gw;
  const py = (v) => pad.top + gh - ((v - minV) / range) * gh;

  // Grid
  ctx.strokeStyle = '#2a2a3a';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 3; i++) {
    const y = pad.top + (gh / 3) * i;
    ctx.beginPath();
    ctx.moveTo(pad.left, y);
    ctx.lineTo(pad.left + gw, y);
    ctx.stroke();
    const val = maxV - (range / 3) * i;
    ctx.fillStyle = '#555568';
    ctx.font = `${10}px sans-serif`;
    ctx.textAlign = 'right';
    ctx.fillText(fmtShort(val), pad.left - 4, y + 4);
  }

  // Area fill
  ctx.beginPath();
  ctx.moveTo(px(0), py(data[0]));
  for (let i = 1; i < data.length; i++) ctx.lineTo(px(i), py(data[i]));
  ctx.lineTo(px(data.length - 1), pad.top + gh);
  ctx.lineTo(px(0), pad.top + gh);
  ctx.closePath();
  const grad = ctx.createLinearGradient(0, pad.top, 0, pad.top + gh);
  grad.addColorStop(0, 'rgba(200,169,110,0.3)');
  grad.addColorStop(1, 'rgba(200,169,110,0)');
  ctx.fillStyle = grad;
  ctx.fill();

  // Line
  ctx.beginPath();
  ctx.moveTo(px(0), py(data[0]));
  for (let i = 1; i < data.length; i++) ctx.lineTo(px(i), py(data[i]));
  ctx.strokeStyle = '#c8a96e';
  ctx.lineWidth = 2;
  ctx.lineJoin = 'round';
  ctx.stroke();

  // Last dot
  const lx = px(data.length - 1);
  const ly = py(data[data.length - 1]);
  ctx.beginPath();
  ctx.arc(lx, ly, 4, 0, Math.PI * 2);
  ctx.fillStyle = '#e8c98e';
  ctx.fill();
}

// =====================================
// MODAL
// =====================================
function showModal(title, body, choices) {
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-body').textContent = body;
  const ch = document.getElementById('modal-choices');
  ch.innerHTML = '';
  choices.forEach(c => {
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.innerHTML = c.label;
    btn.onclick = () => {
      c.effect();
      closeModal();
    };
    ch.appendChild(btn);
  });
  document.getElementById('modal-overlay').classList.add('show');
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('show');
}

// =====================================
// HELPERS
// =====================================
function addLog(msg, type = '') {
  G.logs.push({ msg, type, day: G.day });
  if (G.logs.length > 50) G.logs.shift();
}

function fmt(n) {
  return Math.abs(n).toLocaleString('ja-JP') + (n < 0 ? 'ï¼ˆèµ¤å­—ï¼‰' : '');
}

function fmtShort(n) {
  if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
  if (n >= 1000) return (n / 1000).toFixed(0) + 'K';
  return Math.round(n).toString();
}

function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
function avg(arr) { return arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0; }
function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

// =====================================
// SAVE / LOAD
// =====================================
function autoSave() {
  try { localStorage.setItem('barnoir_save', JSON.stringify(G)); } catch(e) {}
}

function saveGame() {
  try {
    localStorage.setItem('barnoir_save', JSON.stringify(G));
    showToast('ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸ');
  } catch(e) { showToast('ã‚»ãƒ¼ãƒ–å¤±æ•—'); }
}

function loadGame() {
  try {
    const data = localStorage.getItem('barnoir_save');
    if (!data) { showToast('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãªã—'); return; }
    G = JSON.parse(data);
    showToast('ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
    render();
  } catch(e) { showToast('ãƒ­ãƒ¼ãƒ‰å¤±æ•—'); }
}

function resetGame() {
  if (!confirm('ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  localStorage.removeItem('barnoir_save');
  document.getElementById('ending-screen').classList.remove('show');
  document.getElementById('gameover-screen').classList.remove('show');
  initState();
  addLog('BAR NOIRã®çµŒå–¶ã‚’é–‹å§‹ã—ãŸ', 'log-good');
  render();
}

// =====================================
// INIT
// =====================================
window.addEventListener('resize', () => drawChart());
document.getElementById('modal-overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('modal-overlay')) closeModal();
});

(function boot() {
  try {
    const saved = localStorage.getItem('barnoir_save');
    if (saved) {
      G = JSON.parse(saved);
      showToast('å‰å›ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
    } else {
      initState();
      addLog('BAR NOIRã®çµŒå–¶ã‚’é–‹å§‹ã—ãŸ', 'log-good');
    }
  } catch(e) {
    initState();
    addLog('BAR NOIRã®çµŒå–¶ã‚’é–‹å§‹ã—ãŸ', 'log-good');
  }
  currentTab = 'main';
  render();
})();
</script>
</body>
</html>
